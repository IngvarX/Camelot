name: Build App

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
    - name: Checkout sources
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    - name: Install dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --configuration Release --no-restore
    - name: Test
      run: dotnet test --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage" --logger "GitHubActions" --logger "trx;LogFileName=test-results.trx" /p:CoverletOutputFormat=opencover --filter FullyQualifiedName!~Ui.Tests || true
    - name: Test Report
      uses: dorny/test-reporter@v1.9.1
      if: always()
      with:
        name: test-results-${{ matrix.os }}
        path: "**/*-results.trx"
        reporter: dotnet-trx
        fail-on-error: true
    - name: Upload coverage to github
      uses: actions/upload-artifact@v4
      with:
        name: Code coverage ${{ matrix.os }}
        path: "**/coverage.cobertura.xml"
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      if: runner.os == 'Linux'
      with:
        token: ${{ secrets.CODECOV_TOKEN }}